const express = require('express');
const fs = require('fs');
var axios = require('axios');
require('dotenv').config();
const { Telegraf } = require('telegraf');
const { message } = require('telegraf/filters');
// const { GoogleTranslater } = require('./controllers/GoogleTranslater');
const { Imagine } = require('./controllers/Imagine');
const { Upscale } = require('./controllers/Upscale');
const { DownloadImage } = require('./controllers/DownloadImage');
const { CleanupText } = require('./controllers/CleanupText');
const translatte = require('translatte');

const app = express();

app.use(express.json());

const bot = new Telegraf(process.env.BOT_TOKEN);

function writeToFileSync(filename, text) {
  try {
    fs.appendFileSync(filename, text + '\n');
    console.log('Строка успешно записана в файл.');
  } catch (err) {
    console.error('Ошибка при записи в файл:', err);
  }
}

let requests = [];
async function splitText(text) {
    text = text.split('\n');
    for (let item of text) {
        writeToFileSync('requests.txt', item);
        item = await translatte(item, {to: 'en'});
        console.log(item.text)
        requests.push(item.text);
    }
}

bot.command('getstatistic', (ctx) => {
  // Установка флага, чтобы не фиксировать следующее сообщение
  ctx.state.ignoreNextMessage = true;

  // Здесь поместите логику для получения статистики
  const statistic = `
  количество сообщений в обработке: ${requests.length}
  `; // Пример ответа со статистикой
  ctx.reply(statistic);
});

bot.on(message('text'), async (ctx) => {
    if (ctx.state.ignoreNextMessage) {
      // Сообщение должно быть проигнорировано
      ctx.state.ignoreNextMessage = false; // Сброс флага
      return;
    }

    await splitText(ctx.message.text);
});

let timer = setInterval(() => {
  if (requests.length !== 0) {
    Imagine(requests[0])
    console.log(requests[0])
    requests.splice(0, 1);
  }  
}, 120000);

function imagineIteration(buttonMessageId, iterations) {
  if (iterations <= 4) {
    Upscale(buttonMessageId, `U${iterations}`);
  } else {
    console.log("Завершено");
    return;
  }

  setTimeout(() => {
    imagineIteration(buttonMessageId, iterations + 1);
  }, 3000);
}

app.post('/imagine', (req, res) => {
  imagineIteration(req.body.buttonMessageId, 1);
});

app.post('/upscale', (req, res) => {
  let name = CleanupText(req.body.content);
  DownloadImage(req.body.imageUrl, `${name}`, name);
})

// Set up webhook
bot.telegram.setWebhook('https://midjourneybot.site/');

// Bind to Express app
app.use(bot.webhookCallback('/'));

app.listen(3000, '127.0.0.1', () => {
  console.log('Сервер запущен на порту 3000');
});
bot.launch();
//admin-533@midjourney-bot-388312.iam.gserviceaccount.com